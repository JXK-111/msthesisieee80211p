function Xprime = car_solver2(t,X)

%%
global current_gear r_gear throttle_angle
global h r_drive
throttle_angle = 20;
we = X(1);
v = X(2);
Ie = 0.2630;
M = 2100;
h = 0.3;
Iw = 2.565;
c = 0.5;
r_drive = 0.3058;
forddata = [
   57.6000  -21.9600    0.2432    2.2000    3.5500   27.2200   41.0800;
   57.6000  -10.9800    0.2671    2.4000    3.9000   28.8800   40.6700;
   57.6000         0    0.2935    2.6000    4.2860   30.6400   40.2600;
   57.6000    7.1850    0.3099    2.8000    4.5250   31.8300   39.7200;
   57.6000   14.2300    0.3276    2.9000    4.7820   33.0800   39.7200;
   57.6000   33.8900    0.3792    3.4000    5.5370   36.8100   38.9100;
   57.6000   54.2300    0.4372    3.9000    6.3830   41.0000   38.0900;
   57.6000   74.5600    0.5002    4.5000    7.3020   45.5800   37.0100;
   57.6000   94.9000    0.5669    5.2000    8.2770   50.4200   36.0600;
   57.6000  115.2000    0.6362    5.9000    9.2890   55.6000   34.8400;
   57.6000  135.6000    0.7106    6.7000   10.3700   61.0500   33.7600;
   57.6000  155.2000    0.7836    7.6000   11.4400   66.4000   32.5400;
   57.6000  260.0000    1.5800   18.7000   20.5400   89.8300   27.5200;
   57.6000  275.3000    1.6490   24.0000   21.4400   93.4200   26.7100;
   57.6000  290.7000    1.7180   39.4000   22.3400   97.0100   26.0300;
   57.6000  306.0000    1.8610   85.0000   23.2600  100.7000   25.2200;
   57.6000  367.1000    2.4300   85.0000   30.3800  115.6000   21.9600;
   68.0700  -21.9600    0.1940    1.7000    2.8330   22.2500   42.9800;
   68.0700  -10.9800    0.2394    2.1000    3.4950   24.4500   42.4300;
   68.0700         0    0.2847    2.5000    4.1570   26.7200   42.0300;
   68.0700    7.1850    0.3137    2.8000    4.5800   28.2700   41.6200;
   68.0700   14.2300    0.3439    3.0000    5.0220   29.8300   41.3500;
   68.0700   35.7900    0.4334    3.8000    6.3280   34.5700   40.2600;
   68.0700   58.1600    0.5228    4.6000    7.6340   39.6800   39.1800;
   68.0700   80.3900    0.6110    5.4000    8.9210   45.0000   38.0900;
   68.0700  102.6000    0.6992    6.2000   10.2100   50.4900   36.8700;
   68.0700  124.9000    0.7887    7.1000   11.5100   56.1100   35.6500;
   68.0700  147.2000    0.8769    8.0000   12.8000   61.9300   34.4300;
   68.0700  168.8000    0.9638    9.0000   14.0700   67.7200   33.2100;
   68.0700  264.1000    1.7700   19.8000   23.0100   89.6600   28.6000;
   68.0700  279.5000    1.8530   25.3000   24.0900   93.3200   27.7900;
   68.0700  295.1000    1.9360   41.0000   25.1700   96.9800   26.9800;
   68.0700  310.6000    2.1010   85.0000   26.2700  100.7000   26.3000;
   68.0700  372.8000    2.7620   85.0000   34.5200  115.8000   23.0500;
   83.7800  -21.9600    0.1991    1.7000    2.9060   20.1500   44.6000;
   83.7800  -10.9800    0.2469    2.2000    3.6050   22.4200   44.2000;
   83.7800         0    0.2973    2.6000    4.3410   24.7500   43.6500;
   83.7800   16.6700    0.3767    3.3000    5.5000   28.5100   42.8400;
   83.7800   33.2100    0.4599    4.0000    6.7140   32.4400   42.0300;
   83.7800   60.4600    0.6035    5.2000    8.8110   39.8200   40.5300;
   83.7800   88.2600    0.7345    6.4000   10.7200   48.6600   38.7700;
   83.7800  116.2000    0.8693    7.7000   12.6900   56.9500   37.0100;
   83.7800  144.1000    1.0140    9.2000   14.8100   64.8400   35.3800;
   83.7800  172.0000    1.1700   10.9000   17.0900   71.1100   34.0300;
   83.7800  199.8000    1.3200   12.7000   19.2800   76.9000   32.8100;
   83.7800  227.1000    1.4790   15.2000   21.5900   82.3500   31.7200;
   83.7800  253.8000    1.6840   18.4000   24.5900   86.5500   30.9100;
   83.7800  269.6000    2.0720   21.5000   26.9400   89.3900   30.2300;
   83.7800  285.5000    2.1770   27.1000   28.3000   93.1100   29.5500;
   83.7800  301.4000    2.2800   43.0000   29.6400   96.8700   28.7400;
   83.7800  317.2000    2.4830   85.0000   31.0400  100.7000   27.9300;
  104.7000  -23.0500    0.2129    1.9000    3.1090   19.3300   46.5000;
  104.7000  -11.5200    0.2810    2.4000    4.1020   21.6700   45.9600;
  104.7000         0    0.3502    3.0000    5.1140   24.0700   45.5500;
  104.7000   18.0300    0.4624    3.9000    6.7510   28.0700   44.7400;
  104.7000   35.9300    0.5783    4.9000    8.4430   32.3000   43.9200;
  104.7000   69.5500    0.7912    6.6000   11.5500   42.3600   41.8900;
  104.7000  103.8000    0.9865    8.4000   14.4000   53.3600   39.7200;
  104.7000  138.1000    1.1870   10.3000   17.3300   63.6600   37.6900;
  104.7000  172.3000    1.4190   12.6000   20.7100   71.3800   36.2000;
  104.7000  206.6000    1.6480   15.3000   24.0600   78.5600   34.7100;
  104.7000  240.9000    1.8820   18.8000   27.4800   84.7200   33.4900;
  104.7000  274.5000    2.1440   26.5000   31.3100   91.9000   32.1300;
  104.7000  308.4000    2.7720   45.2000   36.0300   96.7000   31.1800;
  104.7000  324.7000    3.0250   85.0000   37.8100  100.7000   30.3700;
  104.7000  389.6000    4.0380   85.0000   50.4700  116.9000   27.1100;
  104.7000  389.6000    4.0380   85.0000   50.4700  116.9000   27.1100;
  104.7000  389.6000    4.0380   85.0000   50.4700  116.9000   27.1100;
  157.1000  -26.9800    0.2784    2.4000    4.0650   17.3000   51.2400;
  157.1000  -13.4200    0.4032    3.4000    5.8860   19.8800   50.8400;
  157.1000         0    0.5291    4.4000    7.7260   22.5800   50.4300;
  157.1000   18.7100    0.7080    5.8000   10.3400   26.5500   49.7500;
  157.1000   37.2800    0.8907    7.2000   13.0000   30.9800   48.9400;
  157.1000   72.8000    1.2090    9.6000   17.6600   42.1200   47.0400;
  157.1000  109.0000    1.5180   12.1000   22.1600   54.1400   45.1400;
  157.1000  145.2000    1.8320   14.6000   26.7500   64.4400   43.3800;
  157.1000  181.5000    2.1640   17.6000   31.6000   73.6100   41.8900;
  157.1000  217.7000    2.5210   21.2000   36.8100   80.4500   40.6700;
  157.1000  253.9000    2.9300   26.0000   42.7800   86.4400   39.7200;
  157.1000  289.4000    3.2210   32.6000   47.0300   91.6300   38.9100;
  157.1000  323.5000    4.1540   51.2000   54.0000   96.4000   38.0900;
  157.1000  340.5000    4.5390   85.0000   56.7400  100.5000   37.4200;
  157.1000  408.6000    6.0810   85.0000   76.0200  117.1000   34.5700;
  157.1000  408.6000    6.0810   85.0000   76.0200  117.1000   34.5700;
  157.1000  408.6000    6.0810   85.0000   76.0200  117.1000   34.5700;
  209.4000  -40.1300    0.2759    2.3000    4.0280   14.3200   56.2600;
  209.4000  -20.0600    0.5165    4.2000    7.5420   17.9100   55.7200;
  209.4000         0    0.7647    6.1000   11.1700   21.7400   55.3100;
  209.4000   18.9800    1.0030    7.9000   14.6400   25.6000   54.7700;
  209.4000   37.9600    1.2350    9.6000   18.0300   30.5400   54.2300;
  209.4000   74.4300    1.6640   12.7000   24.3000   40.5000   53.0100;
  209.4000  111.4000    2.0850   15.7000   30.4400   52.4200   51.5200;
  209.4000  148.6000    2.5220   18.8000   36.8300   62.6100   50.3000;
  209.4000  185.6000    2.9750   22.1000   43.4300   72.0500   49.0800;
  209.4000  222.7000    3.4480   25.9000   50.3400   78.8900   48.2600;
  209.4000  259.7000    3.9570   31.3000   57.7800   86.2400   47.4500;
  209.4000  296.2000    4.4210   39.4000   64.5400   91.9000   46.6400;
  209.4000  329.4000    5.6280   53.8000   73.1600   95.6900   46.2300;
  209.4000  346.8000    6.1630   85.0000   77.0400   99.8200   45.6900;
  209.4000  416.1000    8.3050   85.0000  103.8000  116.3000   43.6500;
  209.4000  416.1000    8.3050   85.0000  103.8000  116.3000   43.6500;
  209.4000  416.1000    8.3050   85.0000  103.8000  116.3000   43.6500;
  261.8000  -51.5200    0.2545    2.1000    3.7160   12.4300   61.0100;
  261.8000  -25.7600    0.6375    5.1000    9.3070   16.7900   60.7300;
  261.8000         0    1.0310    8.1000   15.0500   21.6000   60.3300;
  261.8000   19.3900    1.3330   10.3000   19.4600   25.4600   60.0600;
  261.8000   38.6400    1.6160   12.3000   23.6000   30.5800   59.7900;
  261.8000   75.9200    2.1750   16.1000   31.7500   40.0200   59.1100;
  261.8000  113.9000    2.7400   19.7000   40.0100   49.8800   58.5700;
  261.8000  151.8000    3.3060   23.2000   48.2700   60.5400   57.8900;
  261.8000  189.8000    3.8880   27.0000   56.7600   70.7300   57.2100;
  261.8000  227.8000    4.5100   31.1000   65.8500   77.8800   56.6700;
  261.8000  265.7000    5.1490   36.5000   75.1800   85.2900   56.2600;
  261.8000  303.0000    5.8370   47.9000   85.2200   92.9100   55.7200;
  261.8000  349.1000    7.8650   85.0000   98.3200   99.0700   55.3100;
  261.8000  418.9000   10.5400   85.0000  131.7000  113.6000   54.3600;
  261.8000  418.9000   10.5400   85.0000  131.7000  113.6000   54.3600;
  261.8000  418.9000   10.5400   85.0000  131.7000  113.6000   54.3600;
  261.8000  418.9000   10.5400   85.0000  131.7000  113.6000   54.3600;
  314.2000  -58.7000    0.2343    2.0000    3.4210   11.6500   65.6200;
  314.2000  -29.4200    0.7610    6.0000   11.1100   16.5900   65.6200;
  314.2000         0    1.3080   10.1000   19.0900   22.1400   65.7500;
  314.2000   16.9500    1.6320   12.4000   23.8200   25.6700   65.7500;
  314.2000   33.8900    1.9400   14.5000   28.3300   30.0300   65.7500;
  314.2000   66.7000    2.5520   18.5000   37.2700   37.9900   65.7500;
  314.2000  100.2000    3.1550   22.2000   46.0600   47.0700   65.8900;
  314.2000  133.7000    3.7660   25.8000   54.9800   56.3400   65.8900;
  314.2000  167.3000    4.3940   29.3000   64.1600   65.3800   65.8900;
  314.2000  200.8000    5.0460   33.1000   73.6700   73.6800   65.8900;
  314.2000  234.3000    5.7320   37.4000   83.6900   80.5900   66.0200;
  314.2000  267.1000    6.5360   45.5000   95.4300   89.4200   66.0200;
  314.2000  315.6000    8.4540   60.2000  109.9000   94.7100   66.0200;
  314.2000  332.3000    9.2160   85.0000  115.2000   98.1900   66.0200;
  314.2000  398.7000   12.2700   85.0000  153.3000  112.1000   66.1600;
  314.2000  398.7000   12.2700   85.0000  153.3000  112.1000   66.1600;
  314.2000  398.7000   12.2700   85.0000  153.3000  112.1000   66.1600;
  366.5000  -61.8200    0.2747    2.3000    4.0100   11.9900   70.5000;
  366.5000  -30.9100    0.9235    7.3000   13.4800   17.4400   70.9000;
  366.5000         0    1.6010   12.1000   23.3800   23.7000   71.4400;
  366.5000   14.6400    1.9300   14.4000   28.1800   26.9500   71.7200;
  366.5000   29.1500    2.2510   16.6000   32.8700   30.9100   72.1200;
  366.5000   57.4800    2.8940   20.7000   42.2500   37.8200   72.8000;
  366.5000   86.6300    3.5310   24.5000   51.5600   45.5100   73.3400;
  366.5000  115.6000    4.1660   28.1000   60.8300   53.6300   74.1600;
  366.5000  144.7000    4.8200   31.5000   70.3800   61.5600   74.8300;
  366.5000  173.7000    5.4970   35.0000   80.2500   69.6500   75.5100;
  366.5000  202.8000    6.2970   39.4000   91.9300   77.9100   76.1900;
  366.5000  231.1000    7.0070   44.5000  102.3000   85.1900   76.8700;
  366.5000  240.6000    7.2170   45.5000  105.4000   85.5000   76.8700;
  366.5000  270.7000    8.8670   52.4000  115.3000   90.7100   77.4100;
  366.5000  285.8000    9.3000   60.5000  120.9000   94.0000   77.6800;
  366.5000  300.8000   10.0900   85.0000  127.1000   97.3800   77.9500;
  366.5000  361.0000   13.2300   85.0000  166.7000  110.9000   79.1700;
  418.9000  -60.3300    0.3868    3.2000    5.6470   13.4800   75.6500;
  418.9000  -30.2300    1.1210    8.7000   16.3700   19.5000   76.8700;
  418.9000         0    1.8910   14.2000   27.6100   26.4100   78.0900;
  418.9000   13.9600    2.2590   16.6000   32.9800   29.9000   78.7700;
  418.9000   27.7900    2.6270   19.0000   38.3500   33.9300   79.4400;
  418.9000   54.2300    3.3300   23.4000   48.6200   41.0000   80.8000;
  418.9000   81.3400    4.0440   27.5000   59.0500   48.4200   82.1500;
  418.9000  108.5000    4.7610   31.3000   69.5100   56.0400   83.5100;
  418.9000  135.6000    5.4840   34.9000   80.0700   63.9600   85.0000;
  418.9000  162.7000    6.2170   38.6000   90.7700   72.1200   86.4900;
  418.9000  189.8000    6.9710   42.8000  101.8000   80.3800   87.9800;
  418.9000  216.2000    7.8500   50.8000  114.6000   89.5300   89.7500;
  418.9000  246.7000    9.7190   61.9000  126.3000   94.0000   90.5600;
  418.9000  259.7000   10.6500   85.0000  132.1000   96.9400   91.1000;
  418.9000  311.7000   14.3800   85.0000  178.3000  108.7000   93.2700;
  418.9000  311.7000   14.3800   85.0000  178.3000  108.7000   93.2700;
  418.9000  311.7000   14.3800   85.0000  178.3000  108.7000   93.2700;
  471.2000  -60.3300    0.4699    3.8000    6.8610   15.4100   81.6100;
  471.2000  -30.2300    1.3030   10.0000   19.0200   22.4500   83.6500;
  471.2000         0    2.1800   16.1000   31.8200   30.5100   85.9500;
  471.2000   11.5200    2.5250   18.4000   36.8600   33.8300   86.9000;
  471.2000   22.9100    2.8930   20.7000   42.2300   37.3500   87.9800;
  471.2000   44.7400    3.5520   24.7000   51.8500   43.9800   89.8800;
  471.2000   67.1100    4.2390   28.5000   61.9000   50.8900   91.9200;
  471.2000   89.6100    4.9270   32.2000   71.9400   57.9700   93.9500;
  471.2000  112.0000    5.6190   35.6000   82.0400   65.2800   96.1200;
  471.2000  134.3000    6.3170   39.1000   92.2300   72.8300   98.4200;
  471.2000  156.7000    7.0300   43.1000  102.6000   80.4500  100.6000;
  471.2000  178.5000    7.7520   49.1000  113.2000   88.0400  102.8000;
  471.2000  193.0000    9.3920   59.8000  122.1000   93.6600  104.5000;
  471.2000  203.8000    9.7890   67.1000  127.3000   95.2800  104.9000;
  471.2000  214.5000   10.1900   85.0000  132.4000   96.9400  105.5000;
  471.2000  257.4000   11.7800   85.0000  153.1000  103.6000  107.4000;
  471.2000  257.4000   11.7800   85.0000  153.1000  103.6000  107.4000];

ford = [forddata(:,1) forddata(:,4) forddata(:,2)];
gshift_rpm = [0.0   369.0   735.0   1631.0   314.0   697.0   1389.0 
4.0   400.0   758.0   1659.0   318.0   698.0   1389.0
5.5   465.0   837.0   1686.0   363.0   721.0   1389.0
9.0   521.0   981.0   1712.0   403.0   743.0   1389.0
12.5  573.0  1106.0   1833.0   439.0   779.0   1413.0
16.0  619.0  1219.0   2034.0   473.0   896.0   1527.0
19.5  663.0  1322.0   2216.0   504.0  1017.0   1633.0
23.0  704.0  1417.0   2385.0   534.0  1125.0   1732.0
26.5  743.0  1507.0   2542.0   562.0  1224.0   1845.0
30.0  779.0  1591.0   2691.0   589.0  1315.0   2022.0
33.5  897.0  1671.0   2831.0   614.0  1400.0   2185.0
37.5 1017.0  1748.0   2965.0   639.0  1481.0   2337.0
41.0 1124.0  1821.0   3093.0   662.0  1557.0   2480.0
45.0 1221.0  1892.0   3216.0   685.0  1629.0   2614.0
49.0 1285.0  1940.0   3330.0   701.0  1678.0   2742.0
49.5 1285.0  1940.0   4302.0   701.0  1678.0   3864.0
90.0 1618.0  2684.0   9000.0  1250.0  2294.0   8000.0];
% Convert gshift_rpm from rpm to rad/s
x2 = gshift_rpm(:,2);
x3 = gshift_rpm(:,3);
x4 = gshift_rpm(:,4);
x5 = gshift_rpm(:,5);
x6 = gshift_rpm(:,6);
x7 = gshift_rpm(:,7);
x_rpm = [x2 x3 x4 x5 x6 x7];
x_rad_s = x_rpm*pi/30;
gshift_rad_s = [gshift_rpm(:,1) x_rad_s]; % gshift_rad_s in units of rad/s
% plot(gshift_rad_s(:,2),gshift_rad_s(:,1));
% hold on;
% plot(gshift_rad_s(:,3),gshift_rad_s(:,1));
% plot(gshift_rad_s(:,4),gshift_rad_s(:,1));
% plot(gshift_rad_s(:,5),gshift_rad_s(:,1));
% plot(gshift_rad_s(:,6),gshift_rad_s(:,1));
% plot(gshift_rad_s(:,7),gshift_rad_s(:,1));
% Return the index for the throttle angle, so the throttle angle lies
% between gshift_index-1 and gshift_index
gshift_throttle_angle = gshift_rad_s(:,1);
carrier_speed = v/(h*r_drive);
% current_gear;
% region = 1;
gshift_index = return_index(gshift_throttle_angle,throttle_angle);
% Linear interpolate gshift_rad_s chart to estimate regions for any
% throttle angle
gshift_interpolation = [throttle_angle ...
    gshift_rad_s(gshift_index-1,2)+(throttle_angle-gshift_rad_s(gshift_index-1,1))*(gshift_rad_s(gshift_index,2)-gshift_rad_s(gshift_index-1,2))/(gshift_rad_s(gshift_index,1)-gshift_rad_s(gshift_index-1,1)) ...
    gshift_rad_s(gshift_index-1,3)+(throttle_angle-gshift_rad_s(gshift_index-1,1))*(gshift_rad_s(gshift_index,3)-gshift_rad_s(gshift_index-1,3))/(gshift_rad_s(gshift_index,1)-gshift_rad_s(gshift_index-1,1)) ...
    gshift_rad_s(gshift_index-1,4)+(throttle_angle-gshift_rad_s(gshift_index-1,1))*(gshift_rad_s(gshift_index,4)-gshift_rad_s(gshift_index-1,4))/(gshift_rad_s(gshift_index,1)-gshift_rad_s(gshift_index-1,1)) ...
    gshift_rad_s(gshift_index-1,5)+(throttle_angle-gshift_rad_s(gshift_index-1,1))*(gshift_rad_s(gshift_index,5)-gshift_rad_s(gshift_index-1,5))/(gshift_rad_s(gshift_index,1)-gshift_rad_s(gshift_index-1,1)) ...
    gshift_rad_s(gshift_index-1,6)+(throttle_angle-gshift_rad_s(gshift_index-1,1))*(gshift_rad_s(gshift_index,6)-gshift_rad_s(gshift_index-1,6))/(gshift_rad_s(gshift_index,1)-gshift_rad_s(gshift_index-1,1)) ...
    gshift_rad_s(gshift_index-1,7)+(throttle_angle-gshift_rad_s(gshift_index-1,1))*(gshift_rad_s(gshift_index,7)-gshift_rad_s(gshift_index-1,7))/(gshift_rad_s(gshift_index,1)-gshift_rad_s(gshift_index-1,1))];
if current_gear == 1
    if carrier_speed >= gshift_interpolation(5)
        next_gear = 2;
    else next_gear = 1;
    end
elseif current_gear == 2
    if carrier_speed >= gshift_interpolation(6)
        next_gear = 3;
    elseif carrier_speed <= gshift_interpolation(2)
        next_gear = 1;
    else next_gear = 2;
    end
elseif current_gear == 3
    if carrier_speed >= gshift_interpolation(7)
        next_gear = 4;
    elseif carrier_speed <= gshift_interpolation(3)
        next_gear = 2;
    else next_gear = 3;
    end
elseif current_gear == 4
    if carrier_speed <= gshift_interpolation(4)
        next_gear = 3;
    else next_gear = 4;
    end
end
current_gear = next_gear;
%[gshift_interpolation(6) carrier_speed current_gear]
r_gear = 1; % setting a dummy value for r_gear
% Determine r_gear from current_gear
if current_gear == 1;
    r_gear = 0.4167;
elseif current_gear == 2;
    r_gear = 0.6817;
elseif current_gear == 3;
    r_gear = 1;
else r_gear = 1.4993;
end;
%Net Torque Calculation
t_net = interpol2(we,throttle_angle, ford);
% Polynomial fit for torque converter data
wpump = we;
w_wheel = v/h;
wturb = w_wheel/(r_drive*r_gear);
wratio = wturb/wpump;
if(wratio < 0.9)
t_pump = 6.1e-03*wpump*wpump + 2.3e-03*wpump*wturb - 4.8e-03*wturb*wturb;
t_turb = 14.4e-03*wpump*wpump - 6.7e-03*wpump*wturb - 5.9e-03*wturb*wturb;
else
t_pump = 12.2e-03*wpump*wpump - 4.8e-03*wpump*wturb - 7.3e-03*wturb*wturb;
t_turb = t_pump;
end
if t_turb == t_pump
    Xprime = [(1/Ie)*(t_net - t_pump)
    1/(M+Iw/h^2+Ie/(r_drive*r_gear*h)^2)*(t_net/(r_gear*r_drive*h)-c*v^2-0.1*M)]
else
Xprime = [(1/Ie)*(t_net - t_pump)
    1/(M+Iw/h^2)*(t_turb/(r_gear*r_drive*h)-c*v^2-0.1*M)]

end


%%
txaccel = Xprime(2);
rxaccel = AutoVehicleProjfn(txaccel);
disp('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%');
end